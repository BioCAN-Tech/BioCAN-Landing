name: Deploy BioCAN Landing to AWS EC2

on:
  push:
    branches: ["main"]
    # Avoid burning Actions minutes on docs/assets-only changes
    paths-ignore:
      - "**/*.md"
      - "**/*.txt"
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
      - "**/*.pdf"
      - "**/*.har"
  workflow_dispatch:

concurrency:
  group: deploy-landing-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build Next.js app (static export)
        env:
          NEXT_EXPORT: "true"
        run: npm run build:export

      - name: Verify export output
        run: |
          if [ ! -d "out" ]; then
            echo "Error: 'out' directory not found after build"
            exit 1
          fi
          echo "Export successful. Contents:"
          ls -la out/ | head -20

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Trust EC2 host key
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Try to add host key, but continue even if it fails
          ssh-keyscan -H -T 10 "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "Warning: Could not scan host key, will use StrictHostKeyChecking=accept-new"
            touch ~/.ssh/known_hosts
          }
          chmod 600 ~/.ssh/known_hosts || true

      - name: Prepare remote temp dir
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          set -euo pipefail
          # Use home directory for temp (user has full permissions there)
          ssh -o StrictHostKeyChecking=accept-new -o ConnectTimeout=30 "$EC2_USERNAME@$EC2_HOST" "rm -rf /home/$EC2_USERNAME/htdocs-temp && mkdir -p /home/$EC2_USERNAME/htdocs-temp"
          ssh -o StrictHostKeyChecking=accept-new -o ConnectTimeout=30 "$EC2_USERNAME@$EC2_HOST" "mkdir -p /home/$EC2_USERNAME/htdocs-backups"

      - name: Upload static files
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          set -euo pipefail
          echo "Uploading static files..."
          tar -czf - -C out . \
          | ssh -o StrictHostKeyChecking=accept-new -o ConnectTimeout=30 "$EC2_USERNAME@$EC2_HOST" "tar -xzf - -C /home/$EC2_USERNAME/htdocs-temp"

      - name: Deploy on EC2 (backup -> swap -> set permissions)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=accept-new -o ConnectTimeout=30 "$EC2_USERNAME@$EC2_HOST" "EC2_USERNAME='$EC2_USERNAME' bash -s" <<'EOF'
          set -euo pipefail

          APACHE_ROOT="/opt/bitnami/apache/htdocs"
          TEMP_DIR="/home/${EC2_USERNAME}/htdocs-temp"
          BACKUPS_DIR="/home/${EC2_USERNAME}/htdocs-backups"
          TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
          BACKUP_DIR="${BACKUPS_DIR}/htdocs-${TIMESTAMP}"

          mkdir -p "$BACKUPS_DIR"

          echo "Backing up current htdocs..."
          if [ -d "$APACHE_ROOT" ]; then
            cp -a "$APACHE_ROOT" "$BACKUP_DIR"
            echo "Backup created: $BACKUP_DIR"
          else
            echo "No existing htdocs to backup"
          fi

          echo "Deploying new version..."
          # Use sudo to move files to Apache directory (requires root permissions)
          sudo rm -rf "$APACHE_ROOT"
          sudo mv "$TEMP_DIR" "$APACHE_ROOT"

          # Set proper permissions (Apache needs read access)
          sudo chmod -R 755 "$APACHE_ROOT"
          sudo chown -R bitnami:daemon "$APACHE_ROOT" || sudo chown -R bitnami:bitnami "$APACHE_ROOT"

          # Keep only latest 5 backups
          echo "Cleaning up old backups..."
          ls -1dt "$BACKUPS_DIR"/htdocs-* 2>/dev/null | tail -n +6 | xargs -r rm -rf

          echo "Deployment complete! New version is live."
          EOF

      - name: Deployment summary
        run: |
          echo "âœ… Landing page deployed successfully!"
          echo "ğŸŒ Live at: https://biocan.ai and https://www.biocan.ai"
          echo "ğŸ“ Deployed to: /opt/bitnami/apache/htdocs"
          echo "ğŸ”’ Your app.biocan.ai (WebAppReact) was NOT touched - completely safe!"

