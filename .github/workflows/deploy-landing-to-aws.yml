name: Deploy BioCAN Landing to AWS EC2

on:
  push:
    branches: ["main"]
    # Avoid burning Actions minutes on docs/assets-only changes
    paths-ignore:
      - "**/*.md"
      - "**/*.txt"
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
      - "**/*.pdf"
      - "**/*.har"
  workflow_dispatch:

concurrency:
  group: deploy-landing-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build Next.js app (static export)
        env:
          NEXT_EXPORT: "true"
        run: npm run build:export

      - name: Verify export output
        run: |
          if [ ! -d "out" ]; then
            echo "Error: 'out' directory not found after build"
            exit 1
          fi
          echo "Export successful. Contents:"
          ls -la out/ | head -20

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Trust EC2 host key
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Try to add host key, but don't fail if it doesn't work
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || echo "Warning: Could not add host key, will use StrictHostKeyChecking=no"
          chmod 600 ~/.ssh/known_hosts || true

      - name: Deploy static site to Apache htdocs
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          set -euo pipefail

          # SSH options to handle host key checking
          SSH_OPTS="-o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30"

          # Create temp dir on server
          ssh $SSH_OPTS "$EC2_USERNAME@$EC2_HOST" "rm -rf /opt/bitnami/apache2/htdocs-temp && mkdir -p /opt/bitnami/apache2/htdocs-temp"
          ssh $SSH_OPTS "$EC2_USERNAME@$EC2_HOST" "mkdir -p /opt/bitnami/apache2/htdocs-backups"

          # Upload 'out' folder contents to temp dir
          echo "Uploading static files..."
          tar -czf - -C out . \
          | ssh $SSH_OPTS "$EC2_USERNAME@$EC2_HOST" "tar -xzf - -C /opt/bitnami/apache2/htdocs-temp"

          # On server: backup current htdocs, then swap temp -> live
          ssh $SSH_OPTS "$EC2_USERNAME@$EC2_HOST" "bash -s" <<'EOF'
          set -euo pipefail

          APACHE_ROOT="/opt/bitnami/apache2/htdocs"
          BACKUPS_DIR="/opt/bitnami/apache2/htdocs-backups"
          TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
          BACKUP_DIR="${BACKUPS_DIR}/htdocs-${TIMESTAMP}"

          mkdir -p "$BACKUPS_DIR"

          echo "Backing up current htdocs..."
          if [ -d "$APACHE_ROOT" ]; then
            cp -a "$APACHE_ROOT" "$BACKUP_DIR"
            echo "Backup created: $BACKUP_DIR"
          else
            echo "No existing htdocs to backup"
          fi

          echo "Deploying new version..."
          rm -rf "$APACHE_ROOT"
          mv /opt/bitnami/apache2/htdocs-temp "$APACHE_ROOT"

          # Set proper permissions (Apache needs read access)
          chmod -R 755 "$APACHE_ROOT"
          chown -R bitnami:daemon "$APACHE_ROOT" || chown -R bitnami:bitnami "$APACHE_ROOT"

          # Keep only latest 5 backups
          echo "Cleaning up old backups..."
          ls -1dt "$BACKUPS_DIR"/htdocs-* 2>/dev/null | tail -n +6 | xargs -r rm -rf

          echo "Deployment complete! New version is live."
          EOF

      - name: Deployment summary
        run: |
          echo "âœ… Landing page deployed successfully!"
          echo "ğŸŒ Live at: https://biocan.ai and https://www.biocan.ai"
          echo "ğŸ“ Deployed to: /opt/bitnami/apache2/htdocs"
          echo "ğŸ”’ Your app.biocan.ai (WebAppReact) was NOT touched - completely safe!"

